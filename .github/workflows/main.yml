name: Deploy Bandu App to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build JAR
        run: ./mvnw clean package -DskipTests -Pprod

      - name: Verify build files
        run: |
          echo "Checking build artifacts..."
          ls -l target/ || echo "target/ directory not found"
          test -f target/bandu-app.jar || (echo "JAR file missing!" && exit 1)
          test -f docker-compose.yml || (echo "docker-compose.yml missing!" && exit 1)
          test -f Dockerfile || (echo "Dockerfile missing!" && exit 1)

      # ðŸ§  Server tayyorlash: Docker, papka, eski containerlarni tozalash
      - name: Prepare server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            echo "=== Installing Docker and Compose if not present ==="
            if ! command -v docker &> /dev/null
            then
              sudo apt-get update
              sudo apt-get install -y ca-certificates curl gnupg lsb-release
              sudo mkdir -p /etc/apt/keyrings
              curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
              echo \
                "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
                https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | \
                sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
              sudo apt-get update
              sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
            fi

            echo "=== Preparing deployment directory ==="
            mkdir -p /home/${{ secrets.SERVER_USER }}/bandu_app
            cd /home/${{ secrets.SERVER_USER }}/bandu_app

            echo "=== Cleaning old containers and images ==="
            sudo docker compose down || true
            sudo docker system prune -f --volumes || true

      # ðŸ“¦ Yangi fayllarni yuborish
      - name: Copy deployment files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          source: "target/bandu-app.jar,docker-compose.yml,Dockerfile"
          target: /home/${{ secrets.SERVER_USER }}/bandu_app
          port: 22
          overwrite: true

      # ðŸš€ Deploy bosqichi
      - name: Deploy new version
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /home/${{ secrets.SERVER_USER }}/bandu_app

            echo "=== Generating .env file ==="
            cat <<EOF > .env
            DATASOURCE_URL=${{ secrets.DATASOURCE_URI }}
              DATASOURCE_USERNAME=${{ secrets.DATASOURCE_USERNAME }}
              DATASOURCE_PASSWORD=${{ secrets.DATASOURCE_PASSWORD }}
              JPA_DDL=${{ secrets.JPA_DDL }}
              JPA_SHOW_SQL=${{ secrets.JPA_SHOW_SQL }}
              JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
              JWT_TOKEN_LIFETIME_DAY=${{ secrets.JWT_TOKEN_LIFETIME_DAY }}
              EOF
            
              sudo apt-get update && sudo apt-get install -y dos2unix
              dos2unix .env
            
              echo "=== Building Docker images ==="
              sudo docker compose build
            
              echo "=== Starting containers ==="
              sudo docker compose up -d
            
              echo "=== Containers status ==="
              sudo docker ps -a
            
              echo "=== Logs from web_app ==="
              sudo docker logs $(sudo docker ps -q --filter "name=web_app") || echo "No web_app logs"
            
              echo "=== Logs from web_db ==="
              sudo docker logs $(sudo docker ps -q --filter "name=web_db") || echo "No web_db logs"