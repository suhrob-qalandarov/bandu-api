name: Deploy Bandu App to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build JAR
        run: ./mvnw clean package -DskipTests -Pprod

      - name: Verify files
        run: |
          ls -l target/ || echo "target/ directory not found"
          ls -l docker-compose.yml || echo "docker-compose.yml not found"
          ls -l Dockerfile || echo "Dockerfile not found"

      - name: Prepare Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            mkdir -p /home/${{ secrets.SERVER_USER }}/bandu_app
            cd /home/${{ secrets.SERVER_USER }}/bandu_app
            sudo docker compose down || true
            sudo docker system prune -f --volumes || true

      - name: Copy build files to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          source: "target/bandu-app.jar,docker-compose.yml,Dockerfile,nginx.conf"
          target: /home/${{ secrets.SERVER_USER }}/bandu_app
          overwrite: true

      - name: Deploy on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          script: |
            cd /home/${{ secrets.SERVER_USER }}/bandu_app

            # .env yaratish â€“ 100% TO'G'RI, HECH QANDAY XATO YO'Q!
            printf '%s\n' \
              'DATASOURCE_URL=${{ secrets.DATASOURCE_URL }}' \
              'DATASOURCE_USERNAME=${{ secrets.DATASOURCE_USERNAME }}' \
              'DATASOURCE_PASSWORD=${{ secrets.DATASOURCE_PASSWORD }}' \
              'JPA_DDL=${{ secrets.JPA_DDL }}' \
              'JPA_SHOW_SQL=${{ secrets.JPA_SHOW_SQL }}' \
              'JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}' \
              'JWT_TOKEN_LIFETIME_DAY=${{ secrets.JWT_TOKEN_LIFETIME_DAY }}' > .env

            # Tekshirish
            echo "=== .env content ==="
            cat .env
            echo "====================="

            sudo docker compose build --no-cache
            sudo docker compose up -d
            sleep 15
            sudo docker ps -a