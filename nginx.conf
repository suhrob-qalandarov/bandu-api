events {
    worker_connections 1024;
}

http {
    # ==================== HTTP (80) — Redirect emas, to'g'ridan-to'g'ri ishlaydi ====================
    server {
        listen 80;
        server_name 51.20.43.58;

        # Swagger va API uchun to'g'ridan-to'g'ri proxy
        location / {
            proxy_pass http://bandu_app:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # CORS — faqat kerak bo'lganda
            proxy_hide_header Access-Control-Allow-Origin;
            add_header Access-Control-Allow-Origin $cors_origin;
            add_header Access-Control-Allow-Credentials $cors_cred;
            add_header Vary Origin;
        }

        # OPTIONS so'rovlar uchun
        location ~ ^/.*$ {
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin $cors_origin;
                add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
                add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Requested-With';
                add_header Access-Control-Allow-Credentials $cors_cred;
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }
    }

    # ==================== HTTPS (443) — To'liq xavfsiz ====================
    server {
        listen 443 ssl;
        server_name 51.20.43.58;

        ssl_certificate /etc/ssl/bandu/bandu.crt;
        ssl_certificate_key /etc/ssl/bandu/bandu.key;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;

        # CORS o'zgaruvchilari
        set $cors_origin "";
        set $cors_cred "";

        # Ruxsat etilgan originlar (HTTP va HTTPS)
        if ($http_origin ~* ^(https?://(?:51\.20\.43\.58|localhost:3000|localhost:3001|localhost:3002|127\.0\.0\.1))) {
            set $cors_origin $http_origin;
            set $cors_cred "true";
        }

        # Swagger va boshqa statik fayllar uchun
        location /swagger-ui.html {
            proxy_pass http://bandu_app:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
        }

        location /v3/api-docs {
            proxy_pass http://bandu_app:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
        }

        location /swagger-ui/ {
            proxy_pass http://bandu_app:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto https;
        }

        # API uchun
        location / {
            proxy_pass http://bandu_app:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto https;

            # CORS headerlar faqat ruxsat etilgan origin uchun
            add_header Access-Control-Allow-Origin $cors_origin;
            add_header Access-Control-Allow-Credentials $cors_cred;
            add_header Vary Origin;
        }

        # OPTIONS so'rovlar uchun (HTTPS)
        location ~ ^/.*$ {
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin $cors_origin;
                add_header Access-Control-Allow-Methods 'GET, POST, PUT, DELETE, PATCH, OPTIONS';
                add_header Access-Control-Allow-Headers 'Authorization, Content-Type, X-Requested-With';
                add_header Access-Control-Allow-Credentials $cors_cred;
                add_header Access-Control-Max-Age 86400;
                add_header Content-Length 0;
                add_header Content-Type text/plain;
                return 204;
            }
        }
    }

    # ==================== CORS o'zgaruvchilari umumiy (ikkala server uchun) ====================
    map $http_origin $cors_origin {
        default "";
        ~*^https?://51\.20\.43\.58$ $http_origin;
        ~*^https?://localhost:3000$ $http_origin;
        ~*^https?://localhost:3001$ $http_origin;
        ~*^https?://localhost:3002$ $http_origin;
        ~*^https?://127\.0\.0\.1(:[0-9]+)?$ $http_origin;
    }

    map $http_origin $cors_cred {
        default "";
        ~*^https?://51\.20\.43\.58$ "true";
        ~*^https?://localhost:3000$ "true";
        ~*^https?://localhost:3001$ "true";
        ~*^https?://localhost:3002$ "true";
        ~*^https?://127\.0\.0\.1(:[0-9]+)?$ "true";
    }
}